name: "UI Tests -> Xray"
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      XRAY_BASE: https://xray.cloud.getxray.app/api/v2
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'   # change if your project uses 17

      - name: Cleanup stray Chrome (best-effort)
        run: |
          pkill -f chrome || true
          pkill -f chromedriver || true

      - name: Run Cucumber tests (headless)
        run:  mvn -B test "-Dtest=bdd.CucumberTest" "-Dheadless=true"

      - name: Show generated reports
        run: |
          ls -la target || true
          echo "---- cucumber.json size ----"
          test -f target/cucumber.json && wc -c target/cucumber.json || echo "NO cucumber.json"
          echo "---- first 80 chars ----"
          test -f target/cucumber.json && head -c 80 target/cucumber.json && echo || true

      # Safe auth debug: verifies your secrets & gets a token
      - name: Import results to Xray Cloud (multipart, with file parts)
        if: ${{ hashFiles('target/cucumber.json') != '' }}
        env:
          XRAY_BASE: https://xray.cloud.getxray.app/api/v2
          JIRA_PROJECT_KEY: KAN          # <-- set your project key here
        run: |
          set -e
          echo "cucumber.json size: $(wc -c < target/cucumber.json)"

          # Build info.json with the required 'fields' (project + summary/description)
          cat > info.json <<JSON
          {
            "fields": {
              "project": { "key": "${JIRA_PROJECT_KEY}" },
              "summary": "Ventus UI E2E - GH #${GITHUB_RUN_NUMBER}",
              "description": "Workflow: ${GITHUB_WORKFLOW}\nRun: ${GITHUB_RUN_ID}\nCommit: ${GITHUB_SHA}\nBranch: ${GITHUB_REF_NAME}"
            },
            "testEnvironments": ["chrome-headless"]
            /* , "testPlanKey": "VENTUS-123" , "fixVersion": "2025.09" */
          }
          JSON

          echo "info.json:"
          cat info.json

          CODE=$(curl -sS -o xray_resp.json -w "%{http_code}" \
            -H "Authorization: Bearer $XRAY_TOKEN" \
            -F "info=@info.json;type=application/json" \
            -F "results=@target/cucumber.json;type=application/json" \
            "$XRAY_BASE/import/execution/cucumber/multipart")

          echo "Import HTTP=$CODE"
          cat xray_resp.json
          test "$CODE" -ge 200 -a "$CODE" -lt 300
